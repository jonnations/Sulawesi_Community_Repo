---
title: "Phylogenetic Diversity"
---

# Phylogenetic Diversity
Estimating Phylognetic Diversity for each assembly using picante::pd and pd.ses. This is Faith's metric of PD. 

First I need to select only Sulawesi species from the large murine phylogeny. Then I need to add in the 4 missing species. 

Once this is done, I can calculate the phylogenetic diversity and the pd standardized effect size for each community. 

*Haeromys minahassae* is an interesting case as it is distantly related to all other species, and looks like an "outgroup" in this tree. I need to see if the effect is large.

Load tree
```{r}
pacman::p_load(tidyverse, phytools, picante)
tr <- read.nexus("Phylogenetic_Diversity/397_MCC.tree")
# Need to take care of some 0 length tips
tr <- drop.tip(tr, c("Pelomys_fallax", "Taeromys_hamatus"))
# This is a matrix of binary 1 or 0 for each species for each community
sp_ses <- read.csv("Phylogenetic_Diversity/Species_SES.csv") %>% select(!X)
#Species lists
load("Species_Lists.Rdata")
load("Species_Extant.Rdata")
# list for initial trim
load("Species_Extant_Tree.Rdata")
# Order
level_order <-  c( 'Bawakaraeng', 'Buliohuto','Dako', "Katopasa", "Ambang", "Latimojong", "Torompupu", "Nokilalaki", "Gandangdewata")
# Just need a DF with species as column names, and one row of data
mdat <- read_csv("External_Measurement_Data/Measurement_Data_Museum.csv") %>% 
  select(c(Species, Total)) %>% 
  group_by(Species) %>% 
  summarise(mTot = mean(Total)) %>% 
  pivot_wider(names_from = Species, values_from = mTot)
```

Trim tree, add tips
What tips are missing from the new species lists?
```{r}
tr %>% keep.tip(., ext_sp)
```

There we go.

#### Maxomys
In Achmadi 2010, wattsi is closely related to rajah, so I can simply change name of rajah to wattsi. 
```{r}
tr$tip.label <- recode(tr$tip.label, Maxomys_rajah = "Maxomys_wattsi")
```

#### Taeromys
Taeromys_sp_katopasa is sister to callitrichus.
In the big Nations 2020 tree, hamatus and callitrichus are likely the same species. I dropped hamatus when I read in the tree. Now I need to rename punicans -> hamatus
```{r}
tr$tip.label <- recode(tr$tip.label, Taeromys_punicans = "Taeromys_hamatus")
```

Ok Now I need to add on the sp_katopasa. It is on the branch with callitrichus.
However there are some branch length issues somewhere in the tree. First I think I need to drop everything but the sulawesi species

```{r}
ext_sp2 <- ext_sp[! ext_sp %in% c("Rattus_botanus",  "Rattus_marmosurus", "Rattus_mollicomulus", "Taeromys_sp_katopasa")]
tr <- tr %>% keep.tip(., ext_sp2)
```

This is critical here to continue! Must solve whatever 0 branch length there is in the tree at this stage.
```{r}
tr <- force.ultrametric(tr)
```

Now add sp_katopasa
This is working and not messing with the node ages, I checked!!
```{r}
node <- which(tr$tip.label=="Taeromys_callitrichus")
tr <- bind.tip(tr, tip.label="Taeromys_sp_katopasa", 
                  where=node, position=1)
plot(tr)
axisPhylo()
```

```{r}
tr %>% keep.tip(., ext_sp)
```

Ok, down to the three rats.

From Manuscript:
We collected trait data for two species that are not included in this phylogeny: Rattus bontanus and Rattus mollicomulus. Previous morphological studies concluded that Rattus bontanus is in the Rattus xanthurus species group, and Rattus mollicomulus is sister to Rattus hoffmani (Musser and Carlton 2005). We added these two taxa in their appropriate locations using the bind.tip() function in phytools (Revell 2012). 
Add to manuscript: In MSW, marmosurus is commonly listed as a subspecies of xanthurus, but sometimes it's own species. So put it in a tip close to xanthurus.

I need to add botanus first, then marmosurus bc marmo is closer to xanthurus than botanus
```{r}
node <- which(tr$tip.label=="Rattus_xanthurus")
tr <- bind.tip(tr, tip.label="Rattus_botanus", 
                  where=node, position=0.9)
plot(tr)
axisPhylo()
```

Ok, now botanus. It needs to be 
```{r}
node <- which(tr$tip.label=="Rattus_xanthurus")
tr <- bind.tip(tr, tip.label="Rattus_marmosurus", 
                  where=node, position=0.2)
plot(tr)
axisPhylo()
```
Down to Rattus_mollicomulus in the hoffmani group

```{r}
node <- which(tr$tip.label=="Rattus_hoffmani")
tr <- bind.tip(tr, tip.label="Rattus_mollicomulus", 
                  where=node, position=1)
plot(tr)
axisPhylo()
```

#### Write Tree

```{r}
write.tree(tr, file = "Phylogenetic_Diversity/Clean_Sulawesi_Tree.tre")
```


## PDSES Function

```{r}
set.seed(111)
sespd <- ses.pd(sp_ses, tr, null.model="independentswap", runs=999, iterations = 1000, include.root=F) %>% as_tibble() %>% arrange(ntaxa) %>% add_column(com = level_order) %>% select(-runs)
sespd <- sespd %>% rename(pd_ses = pd.obs.z) #%>% write_csv(file = "Phylogenetic_Diversity/PD_Results.csv")
sespd
```

```{r}
p1 <- sespd %>% mutate(com = factor(com, level = level_order)) %>% ggplot(aes(x = ntaxa, y=pd_ses, color = com, fill = com)) + 
#geom_point(size = 10) + 
geom_jitter(size = 5, width = 1.25, alpha = 0.85) +
ylim(-2.5, 2.5) + 
  geom_hline(yintercept = 0) + scale_color_viridis_d(direction = -1, begin = 0, end = 0.95,  option = "A") + theme_classic() + ggtitle("Phylo Div") +
  guides(fill = guide_legend(reverse=T), color = guide_legend(reverse=T),
         color = guide_legend(override.aes = list(size = 1)))
p1
```

## PD Without Haeromys

```{r}
sp_ses2 <- sp_ses %>% select(!Haeromys_minahassae)
tr2 <- drop.tip(tr, "Haeromys_minahassae")
sespd2 <- ses.pd(sp_ses2, tr2, null.model="independentswap", runs=999, iterations = 1000, include.root=F) %>% as_tibble() %>% arrange(ntaxa) %>% add_column(com = level_order) %>% select(-runs)
sespd2 <- sespd2 %>% rename(pd_ses = pd.obs.z) %>% write_csv(file = "Phylogenetic_Diversity/PD_Results_no_Hae.csv")
```


```{r}
p1.2 <- sespd2 %>% mutate(com = factor(com, level = level_order)) %>% ggplot(aes(x = ntaxa, y=pd_ses, color = com, fill = com)) + 
#geom_point(size = 10) + 
geom_jitter(size = 5, width = 1.25, alpha = 0.85) +
ylim(-2.5, 2.5) + 
  geom_hline(yintercept = 0) + scale_color_viridis_d(direction = -1, begin = 0, end = 0.95,  option = "A") + theme_classic() + ggtitle("Phylo Div") +
  guides(fill = guide_legend(reverse=T), color = guide_legend(reverse=T),
         color = guide_legend(override.aes = list(size = 1)))
p1.2
```

## Net Relatedness Index
Sample codes here : `https://pedrohbraga.github.io/CommunityPhylogenetics-Workshop/CommunityPhylogenetics-Workshop.html#between-assemblage-phylogenetic-structure`

"Negative NRI values indicate phylogenetic overdispersion, i.e. co-occurring taxa is less closely related than expected by a given null model; while positive NRI values represent phylogenetic clustering, i.e. co-occurring taxa are more closely related than expected by a null model."


*Important* : NRI is obtained by multiplying the standardized effect size mean phylogenetic (pairwise) distances (calculated via a null model of interest) by âˆ’1.
```{r}
set.seed(123)
sesmpd <- ses.mpd(sp_ses, cophenetic.phylo(tr), null.model="independentswap", runs=100, iterations = 1000) %>% 
  as_tibble() %>% 
  arrange(ntaxa) %>% 
  add_column(com = level_order) %>% 
  select(-runs) %>% 
  mutate(NRI = -1 * mpd.obs.z) %>% 
  select(ntaxa, mpd.obs.p, com, NRI)

sesmpd
```
Species in Gandang are much less related than expected by chance, while species in Kato and Bawa are much more related than expected by chance. The rest are kinda mishmashed. This means that species in Totompupu, Nokilalaki, and Gandang are phylogenetically overdispersed and demonstrate trait overdispersion. 

```{r}
p2 <- sesmpd %>% mutate(com = factor(com, level = level_order)) %>% ggplot(aes(x = ntaxa, y=NRI, color = com, fill = com)) + 
#geom_point(size = 10) + 
geom_jitter(size = 5, width = 1.25, alpha = 0.85) +
ylim(-2.5, 2.5) + 
  geom_hline(yintercept = 0) + scale_color_viridis_d(direction = -1, begin = 0, end = 0.95,  option = "A") + ggtitle("Net Relatedness") + theme_classic() + 
  guides(fill = guide_legend(reverse=T), color = guide_legend(reverse=T),
         color = guide_legend(override.aes = list(size = 1)))

p2
```

```{r}
library(patchwork)
p1 + p2 + plot_layout(guides = 'collect') + plot_annotation(title ='These Are Just Opposites! Overdispersion in the Species-Rich Communities')
```

## Nearest Taxon Index
                          
"Another way to assess the phylogenetic structure of communities is through the calculation of the nearest taxon index (NTI). NTI differs from NRI by being based on the mean nearest neighbour phylogenetic distance (MNTD), instead of the overall mean pairwise distances (MPD).
MNTD is obtained by calculating the mean phylogenetic distance of each taxon of a given community to its nearest neighbour in a tree. By doing this, one can observe that NTI is more sensitive to the clustering or overdispersion patterns happening closer to the tips of a tree, while NRI represents an overall pattern of structuring across the whole phylogenetic tree."

```{r}
set.seed(123)
sesmntd <- ses.mntd(sp_ses, cophenetic.phylo(tr), null.model="independentswap", runs=100, iterations = 1000) %>% 
  as_tibble() %>% 
  arrange(ntaxa) %>% 
  add_column(com = level_order) %>% 
  select(-runs) %>% 
  mutate(NTI = -1 * mntd.obs.z) %>% 
  select(ntaxa, mntd.obs.p, com, NTI)

sesmntd
```
Different Story here! Very closely related taxa live in Gandang and Torompupu and Dako, while distantly related taxa live in Kato and Bawa



## Phylogenetic Beta Diversity
Not really important!

```{r}
ps <- phylosor(sp_ses, tr)
ps2 <- phylosor.rnd(sp_ses, tr, cstSor=FALSE, null.model = "independentswap",runs = 100)
```

THis function comes from:
https://pedrohbraga.github.io/CommunityPhylogenetics-Workshop/CommunityPhylogenetics-Workshop.html#between-assemblage-phylogenetic-structure
```{r}
psses <- ses.PBD(obs = ps,
                           rand = ps2)

psses
```
So Katopasa and Gandang are very similar, while Gandang and Noki are very dissimilar!?! High values = dissimilar, low = similar.
```{r}
psses.m <- ps 
# assign SES_PhyloSor value to each cell
for(i in 1:length(ps)) {psses.m[i] <- psses$pbd.ses[i]}

# plot heatmap using ggplot this time!
library(ggplot2)
library(reshape2)
psses.m %>% as.matrix() %>% melt() %>% # manipulate data into a format that works for ggplot
  ggplot() + 
  geom_tile(aes(x = Var1, y = Var2, fill = value)) + # create the heatmap
  scale_fill_gradient2(low = "blue", mid = "white", high = "red") + # create a diverging color palette
  xlab("sites") + ylab("sites") + labs(fill = "SES_PhyloSor") + # edit axis and legend titles
  theme(axis.text.x = element_text(angle = 90)) # rotates x axis labels
```

