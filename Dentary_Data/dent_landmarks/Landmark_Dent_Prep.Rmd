---
title: "Preparing MorphoDig Landmark Files for Geomorph"
author: "Jon Nations"
date: "11/28/2021"
output: html_document
---
## Updated on 28 November 2021
#Finally, Exploring Landmark Data
#### Only 4 years in the making!
This is the first pass at wrangling and loading landmark data and estimating NA values. After that, I practiced running Generalized Procrustes Analysis, Principal Components Analysis, and generating the size centroids for each specimen.

Additionally I used the distance formula to calculate distance from center (0,0) for each specimen on 2-5 Principal Components. Results look pretty good! 

This has also given me a chance to see if anything is really wacky. I found 3 different errors just from looking at the GPA plot and the PCA scores. 



## Loading Data

#### Getting MorphoDig .stv to 3D array for geomorph
MorphoDig outputs " " separated files with 7 columns, the first is the name of the landmark (i.e. "LANDMARK 1"), the second three are x,y,z coords, and the third are the x,yz orientation of the "normale" (not sure what that is exactly). 

There is a nice trick for text files into R in an array that's acceptable for geomorph. They are found on page 12 of the instruction manual here: http://people.tamu.edu/~alawing/materials/ESSM689/Quick_Guide_to_Geomorph_v2.0.pdf

I figured out a way to make it work for these MorphoDig files....

#### File Names
The names of the files will be the names in the analysis, so in my first attempt here I need to rename all the files. I did [G]enus_[spe]cies_last-number-in-catalog-number

So Bunomys andrewsi AMNH 1234 would be B_and_4.stv

#### NA values
If there are NAs they need to be NA in the cell, not blank, not -999, etc. 
This round I only have 1 specimen with NAs, the Hyorhinomys.

#### libraries
```{r}
pacman::p_load(geomorph, tidyverse)
```


#### Read in files 

Here we go, reading in the files. This will be heavily annotated
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/Dicrostonyx/Documents/Projects/Sulawesi/Manuscript/R/dent_landmarks")
```

```{r}
# makes a list of all .txt files in working directory
filelist <-list.files(pattern = ".stv")

#extracts names of specimens from the file name
names <-gsub (".stv", "", filelist) 

# make an empty object
coords = NULL 

# Read in...
# Now I want to read in just the columns 2,3,4 to this using read table <- colClass
#I also want to exclude the top line <- skip=1
for (i in 1:length(filelist)){
tmp <-as.matrix(read.table(filelist[i], colClasses = c("NULL", "numeric", "numeric", "numeric", "NULL", "NULL"), skip = 1))
coords <-rbind(coords, tmp)
}

# Making coords into an array
# arrayspecs is (Matrix, N landmarks, N dimensions), so coords, 20, and 3 this time.
coords <-arrayspecs(coords, 20, 3)

# name each matrix in the array
dimnames(coords)[[3]] <-names
```

That worked perfectly, and it actually put them in alphabetical order too!

#### Estimate NA values

Nothing works with NA values, so I need to fill in those gaps using `estimate.missing()`
This has two methods, TPS and Reg. TPS uses the thin-plate spline to interpolate landmarks on a reference specimen to estimate the locations of missing landmarks on a target specimen. Reg is multivariate regression. Here each landmark with missing values is regressed on all other landmarks for the set of complete specimens, and the missing landmark values are then predicted by this linear regression model. 

Lets do Reg
```{r}
coords <- estimate.missing(coords, method = "Reg")
```


#### Lets Try a GPA

Attempting a generalized Procrustes analysis
There are no curves or semilandmarks, so this is pretty easy. There are some other options but I don't know how those apply
```{r}
gcoords <- gpagen(coords)
```
This produces an extra window of a 3D rotation image of the transformed variables
```{r}
plot(gcoords)
```

Also the centroid size gives a really nice measure of size (skull size in this case) that can be used later.
Here, P doms have the largest, then L mey. H min has the smallest. Things make sense!
```{r}
sort(gcoords$Csize)
```

#### PCA plot

This is what I've been so looking forward to since Spring 2017!
Need to use the GPA coords here.
If I need to take a species mean here I can (but not yet)

```{r}
gm.prcomp(gcoords$coords)

t <- print(gm.prcomp(gcoords$coords))$PC.summary %>% t() %>%  as_tibble() %>% write_csv("Dentary_PCA_Eigen_Variance.csv")
```

### Mesh shape

Attempting to make meshes

This appears to make meshes for each individual by number

THe Y axis is upside down, so I am switching these around for the plotting here. 
```{r}
ref <- mshape(gcoords$coords)  %>% as_tibble() %>% mutate(Y = Y*-1) %>% as.matrix()
p <-  gcoords$coords[,,55] %>% as_tibble() %>% mutate(Y = Y*-1) %>% as.matrix()
plotRefToTarget(ref,p,method="TPS", mag=0.5, useRefPts = T, axes = F)
```

# Save PC Data
The first 20 PCs sum to 95.1 of the variance, so save those
```{r}
sz <- gcoords$Csize %>% as_tibble()
pcdat <- as.data.frame(pc1$x[,1:20]) %>% 
  rownames_to_column() %>% 
  bind_cols(sz) %>%
  rename(Csize = value) %>% 
  # Changing R marmosurus Csize to 120 to match R xanthurus
  mutate(Csize=replace(Csize, rowname=="R_mar_0", 120)) %>% 
  write_csv("PCData_Dent_updates_20211128.csv")
  
```
