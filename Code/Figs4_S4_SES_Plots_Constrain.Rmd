---
title: "Plot Values, SES, NN, and Regression Slopes"
author: "Jon Nations"
date: "4/14/2021"
output: html_document
---

# Fig 4 & S2
Plotting the SES values on the y axis with the nspecies on the x axis. 
2 plots; one for density and one for variance ses.


#Packages and Info
```{r}
pacman::p_load(here, tidyverse, tidybayes,  modelr, patchwork)

here::i_am('Code/Models_Fitted_Variance.Rmd')

load(here("Species_Data", "Species_Lists.Rdata"))

# Rat Color Palette
load(here("Species_Data", "Rat_Colors.Rdata"))

level_order <-  c( 'Bawakaraeng', 'Buliohuto','Dako', 'Katopasa',  "Ambang", "Latimojong", 'Torompupu', 'Nokilalaki', "Gandangdewata")
level_order2 <-  c( 'Bawakaraeng', 'Buliohuto',"Dako",'Ambang',  "Latimojong", "Gandangdewata")
```

# Load Data
```{r}
dat <- read_csv(here("All_Traits.csv")) %>% 
  select(-.draw)%>% 
  select(c(com, contains('ses'))) %>% 
  arrange(factor(com, levels = level_order)) %>% 
  mutate(nspec = rep(c(7, 10, 11.9, 12.1, 12.9, 13.1, 15, 17, 23 ), each = 4000)) 


ldat <- read_csv(here("Locomotion_Data", "All_Locomotor_Var.csv")) %>%
  arrange(factor(com, levels = level_order)) %>% 
  mutate(nspec=replace(nsp, com == "Katopasa", 12.3),
         nspec=replace(nsp, com == "Dako", 11.7),
         nspec=replace(nsp, com == "Ambang", 12.7),
         nspec=replace(nsp, com == "Latimojong", 13.3))


pdat <- read_csv(here("Phylogenetic_Diversity", "PD_Results.csv"))  %>%
  arrange(factor(com, levels = level_order)) %>% 
  mutate(nspec=replace(ntaxa, com == "Katopasa", 12.3),
         nspec=replace(ntaxa, com == "Dako", 11.7),
         nspec=replace(ntaxa, com == "Ambang", 12.7),
         nspec=replace(ntaxa, com == "Latimojong", 13.3))
# Colors taken from Viridis palette, starting at 0.95 on the yellow side
```

# Plots

## SES Var Combined Traits
```{r}
p1 <- dat %>% 
select(com, nspec, ses_morpho, ses_ext, ses_vBsz, ses_vsk, ses_vIso_group) %>% 
  rename('External Proportions' = ses_ext,
         'Morphology' = ses_morpho,
         'Body Size' = ses_vBsz,
         'Head Shape' = ses_vsk,
         'Isotopic Niche Space' = ses_vIso_group) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "SES",
       subtitle = "Ecospaces") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
```

## SES Skull
```{r}
p2 <- dat %>% 
select(com, nspec, ses_cv_wei, ses_dv_wei, ses_vdCsize, ses_vcCsize) %>% 
  rename('Cranium Shape' = ses_cv_wei,
         'Dentary Shape' = ses_dv_wei,
         'Cranium Size' = ses_vcCsize,
         'Dentary Size' = ses_vdCsize) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "SES",
       subtitle = "Skull Traits") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
p2
```

## SES Ext
```{r}
p3 <- dat %>% 
select(com, nspec, ses_vHB, ses_vHF, ses_vTail, ses_vMass, ses_vEar) %>%
  rename('Head-Body Length' = ses_vHB,
         'Tail Length' = ses_vTail,
         'Hind Foot Length' = ses_vHF,
         "Ear Length" = ses_vEar,
         'Mass' = ses_vMass) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "SES",
       subtitle = "External Measurements") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
p3
```

## SES Iso
```{r}
ldat2 <- ldat %>% select(com, ses_loc_prob)
pdat2 <- pdat %>% select(com, pd_ses)

xLabels <- c("Bawakaraeng (7)", "Buliohuto (10)", "Dako (12)", "Katopasa (12)", "Ambang (13)", "Latimojong (13)", "Torompupu (15)", "Nokilalaki (17)", "Gandang Dewata (23)")


p4 <- dat %>% 
select(com, nspec, ses_vC13_group, ses_vN15_group) %>%
  right_join(ldat2, by = 'com') %>% 
  right_join(pdat2, by = 'com') %>% 
  rename('Nitrogen 15' = ses_vN15_group,
         'Carbon 13' = ses_vC13_group,
         'Locomotor Mode' = ses_loc_prob,
         'Phylogenetic Diversity' = pd_ses) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
    mutate(var = factor(var, levels = c("Nitrogen 15", "Carbon 13","Locomotor Mode", "Phylogenetic Diversity"))) %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = "Species Richness",
       y = "SES",
       subtitle = "Isospace, Locomotor & Phylogenetic Diversity") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "", 
                     labels = c("Nitrogen 15" = expression(delta^15~N),
                                "Carbon 13" = expression(delta^13~C))) +
  scale_x_continuous(breaks = c(7, 10, 11.77 ,12.23, 12.77,13.23, 15, 17, 23),
                     labels = xLabels) +
  theme_classic() + 
  theme(legend.justification = "left",
        legend.text.align = 0,
        axis.text.x = element_text(angle = -50, vjust = 1, hjust = 0, size = 8))#, vjust = -1))
p4 
```

# SES ALL
```{r}
p1 / p2 / p3 / p4 #+ plot_layout(guides = 'collect')

```

#NNSES 

## NNSES Var Combined
```{r}
xLabels <- c("Bawakaraeng (7)", "Buliohuto (10)", "Dako (12)", "Katopasa (12)", "Ambang (13)", "Latimojong (13)", "Torompupu (15)", "Nokilalaki (17)", "Gandang Dewata (23)")


n1 <- dat %>% 
select(com, nspec, c_nnses_morpho, c_nnses_ext, c_nnses_Bsz, c_nnses_sk, c_nnses_iso) %>% 
  rename('External Proportions' = c_nnses_ext,
         'Morphology' = c_nnses_morpho,
         'Body Size' = c_nnses_Bsz,
         'Head Shape' = c_nnses_sk,
         'Isotopic Niche Space' = c_nnses_iso) %>%
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "Nearest Neighbor SES",
       subtitle = "Ecospace Densities") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
n1
```

## NNSES Cranial
```{r}
n2 <- dat %>% 
select(com, nspec, c_nnses_c, c_nnses_d, c_nnses_csize, c_nnses_dsize) %>% 
  rename('Cranium Shape' = c_nnses_c,
         'Dentary Shape' = c_nnses_d,
         'Cranium Size' = c_nnses_csize,
         'Dentary Size' = c_nnses_dsize) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c( 0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "Nearest Neighbor SES",
       subtitle = "Skull Trait Densities") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
n2
```

## NNSES EXT
```{r}
n3 <- dat %>% 
select(com, nspec, c_nnses_HB, c_nnses_HF, c_nnses_Tail, c_nnses_Mass, c_nnses_Ear) %>%
  rename('Head-Body Length' = c_nnses_HB,
         'Tail Length' = c_nnses_Tail,
         'Hind Foot Length' = c_nnses_HF,
         "Ear Length" = c_nnses_Ear,
         'Mass' = c_nnses_Mass) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c(0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = NULL,
       y = "Nearest Neighbor SES",
       subtitle = "External Measurement Densities") +
  ylim(-3.1, 3.1) +
  scale_color_manual(values = ratpal, name = "") +
  scale_x_continuous(breaks = c(7, 10, 12, 13, 15, 17, 23)) +
  theme_classic() + 
  theme(legend.justification = "left")
n3
```

## NNSES ISO
```{r}
ldat2 <- ldat %>% select(com, c_nnses_loc)


n4 <- dat %>% 
select(com, nspec, c_nnses_C13, c_nnses_N15) %>%
  right_join(ldat2, by = 'com') %>%
  rename('Nitrogen 15' = c_nnses_N15,
         'Carbon 13' = c_nnses_C13,
         'Locomotor Mode' = c_nnses_loc) %>% 
  pivot_longer(!c(com, nspec), 
               names_to = "var") %>% 
  mutate(var = factor(var, levels = c("Nitrogen 15", "Carbon 13","Locomotor Mode"))) %>% 
  ggplot(aes(y = value, 
             x = nspec, 
             color = var)) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1.64485, 
             linetype = "dotted") +
  geom_hline(yintercept = -1.64485, 
             linetype = "dotted") +
  stat_pointinterval(.width = c( 0.74, 0.89), 
                     position = position_dodge(width = 0.8)) +
  labs(x = "Species Richness",
       y = "Nearest Neighbor SES",
       subtitle = "Isospace & Locomotor Densities") +
  ylim(-3.1, 4.3) +
  scale_color_manual(values = ratpal, name = "", 
                     labels = c("Nitrogen 15" = expression(delta^15~N),
                                "Carbon 13" = expression(delta^13~C))) +
  scale_x_continuous(breaks = c(7, 10, 11.77 ,12.23, 12.77,13.23, 15, 17, 23),
                     labels = xLabels) +
  theme_classic() + 
  theme(legend.justification = "left",
        legend.text.align = 0,
        axis.text.x = element_text(angle = -50, vjust = 1, hjust = 0, size = 8))
n4 
```

# NNSES All
```{r}
(n1 + n2) / (n3 + n4) #+ plot_layout(guides = 'collect')

```




# Variance Plots


#### Variance Plots Vertical
```{r}
p1 / p2 / p3 / p4 + plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = list(c('A', 'B', 'C', 'D')))
  

#ggsave(file = here("Plots", "Fig4_Variance_Richness_Plots_Vertical-com_labels.pdf"), height = 11, width = 7.5)
#ggsave(file = here("Plots", "Fig4_Variance_Richness_Plots_Vertical-com_labels.png"), height = 11, width = 7.5)
```

# Density Plots


```{r}
n1 / n2 / n3 / n4 + plot_layout(tag_level = 'new') +
  plot_annotation(tag_levels = list(c('A', 'B', 'C', 'D')))
  

#ggsave(file = here("Plots", "FigS2_Density_Richness_Plots_vertical-com_labels.pdf"), height = 10, width = 7.5)
```

