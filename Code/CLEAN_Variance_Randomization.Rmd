---
title: "Randomization"
---

# Variance randomization

This notebook generates null distributions of trait variance for each community by sampling species at random from the entire Sulawesi species pool. The richness of each community is held constant.


IMPORTANTLY: Values are being drawn from and added to the `sesdat` dataset stored at `Randomization_Data/All_Variances+ses.csv` and will be updated. This way I will have all the estimates, ses, and ses in one datasheet.


#### Load Packages and Data  
```{r}
pacman::p_load(tidyverse, tidybayes, patchwork, modelr, forcats, picante, furrr)
#supress dplyr messages for summarise()
options(dplyr.summarise.inform = FALSE)

#External Data
edat <- read_csv("External_Measurement_Data/External_Fitted.csv")
# Cranial Data
cdat <- read_csv("Cranial_Data/Cranial_36axes_Fitted.csv") %>%
  mutate_if(is.numeric, round, digits=6)
# Dentary Data
ddat <- read_csv("Dentary_Data/Dentary_20axes_Fitted.csv") %>%
  mutate_if(is.numeric, round, digits=6)

skdat <- ddat  %>% select(!.row) %>% 
  full_join(cdat, by = c(".draw", "Species"))

mdat <- edat  %>% select(!.row) %>% 
  full_join(skdat, by = c(".draw", "Species"))


# Locomotor Data
ldat <- read_csv("Locomotion_Data/Locomotion_List.csv") # List of species modes
lvdat <- read_csv("Locomotion_Data/All_Locomotor_Var.csv") # variances by community


# Changing this up!
ifit <- read_csv("Isotope_Data/Isotope_Group_Level_Fitted.csv")


#adat <- read_csv("CLEAN_All_Traits.csv") 
sp_ses <- read.csv("Phylogenetic_Diversity/Species_SES.csv") %>% select(!X)

load("Species_Lists.RData")
load("Species_Extant.RData")

#Just as a reminder
n_sp <- tibble(com = c("Ambang", "Bawakaraeng", "Buliohuto", "Dako", "Gandangdewata", "Katopasa", "Latimojong", "Nokilalaki", "Torompupu"),
               num = c(13, 7, 10, 12, 23, 12, 13, 17, 15))

level_order <-  c( "Bawakaraeng", "Buliohuto", "Dako", "Katopasa", "Ambang", "Latimojong", "Torompupu", "Nokilalaki", "Gandangdewata")

```

`furrr` options for multithreading. 
```{r}
furrr_options(seed = TRUE)
options(future.rng.onMisuse="ignore")
plan(multisession, workers = 6)
```


# Sample Species

Generate 1000 fake communities using the independent swap algorithm.

New sample species using independent swap algorithm from picante
very helpful: https://stackoverflow.com/questions/61740025/dplyr-how-to-collapse-binary-and-mutually-exclusive-columns-into-1
```{r}
sample_com <- function(com) {
dlist <- list()
for (i in 1:100){
  b <- picante::randomizeMatrix(sp_ses, null.model = "independentswap", iterations = 1000) %>% 
    as_tibble() %>% 
    bind_cols(com = c("Ambang", "Bawakaraeng", "Buliohuto", "Dako", "Gandangdewata", "Katopasa", "Latimojong", "Nokilalaki", "Torompupu")) %>% 
    pivot_longer(cols = -com, names_to = 'species') %>%
    filter(as.logical(value)) %>%
    select(-value) %>%
    filter(com == {{com}}) %>% 
    select(-com) %>%
    pull(species)
  dlist[[i]] <- b
  }
dlist
}
```

```{r}
sp_amb <- sample_com("Ambang" )
sp_baw <- sample_com("Bawakaraeng" )
sp_bul <- sample_com("Buliohuto" )
sp_dak <- sample_com("Dako" )
sp_gan <- sample_com("Gandangdewata" )
sp_kat <- sample_com("Katopasa")
sp_lat <- sample_com("Latimojong")
sp_nok <- sample_com("Nokilalaki")
sp_tor <- sample_com("Torompupu")
```

# External Randomization

#### External Varaince Function

```{r}
get_xvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>%
        summarise(
            vHB = var(HB), 
            vHF = var(rHF), 
            vTail = var(rTail), 
            vEar = var(rEar),
            vMass = var(lMass),
            vBsz = (var(HB) +  var(lMass)) / 2,
            vExt = (var(HB) + var(rHF) + var(rTail) + var(rEar) + var(lMass)) / 5)) %>%
  bind_rows() %>% 
  as_tibble() %>% 
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```
External Variance and Summaries
This will take an hour or more
```{r}
xamb <- future_map(sp_amb, ~ get_xvar(.x, edat, "Ambang"), chunks = 1000) %>% bind_rows()
xbaw <- future_map(sp_baw, ~ get_xvar(.x, edat, "Bawakaraeng"), chunks = 1000) %>% bind_rows()
xbul <- future_map(sp_bul, ~ get_xvar(.x, edat, "Buliohuto"), chunks = 1000) %>% bind_rows()
xdak <- future_map(sp_dak, ~ get_xvar(.x, edat, "Dako"), chunks = 1000) %>% bind_rows()
xgan <- future_map(sp_gan, ~ get_xvar(.x, edat, "Gandangdewata"), chunks = 1000) %>% bind_rows()
xkat <- future_map(sp_kat, ~ get_xvar(.x, edat, "Katopasa"), chunks = 1000) %>% bind_rows()
xlat <- future_map(sp_lat, ~ get_xvar(.x, edat, "Latimojong"), chunks = 1000) %>% bind_rows()
xnok <- future_map(sp_nok, ~ get_xvar(.x, edat, "Nokilalaki"), chunks = 1000) %>% bind_rows()
xtor <- future_map(sp_tor, ~ get_xvar(.x, edat, "Torompupu"), chunks = 1000) %>% bind_rows()

x_rand <- bind_rows(xamb, xbaw, xbul, xdak, xgan, xkat, xlat, xnok, xtor) 
```

# External SES
```{r}
adat <- 
  x_rand %>% group_by(com) %>% 
  summarise(mHB = mean(vHB),
            sdHB = sd(vHB),
            mHF = mean(vHF),
            sdHF = sd(vHF),
            mTail = mean(vTail),
            sdTail = sd(vTail),
            mEar = mean(vEar),
            sdEar = sd(vEar),
            mMass = mean(vMass),
            sdMass = sd(vMass),
            mBsz = mean(vBsz),
            sdBsz = sd(vBsz),
            mExt = mean(vExt),
            sdExt = sd(vExt)) %>% 
  as.data.frame() %>% 
  right_join(adat, by="com") %>%
  mutate(ses_vHB =  (vHB - mHB) / sdHB,
         ses_vHF = (vHF - mHF) / sdHF,
         ses_vTail = (vTail - mTail) / sdTail,
         ses_vEar = (vEar - mEar) / sdEar,
         ses_vMass = (vMass - mMass) / sdMass,
         ses_vBsz = (vBsz - mBsz) / sdBsz,
         ses_ext = (ext_scaled - mExt) / sdExt) %>% 
  select(!c(mHB,sdHB, mHF, sdHF, mTail, sdTail, mEar, sdEar, mMass, sdMass, mBsz, sdBsz, mExt, sdExt))
```



#### Add data to file
This is hashed out because it only should be done once, and data needs to be looked at to confirm that it is correct and safe to add. Definitely inspect before saving!!!


```{r}
#adat %>% write_csv("CLEAN_All_Traits.csv")
rm(x_rand)
```



# Cranial Randomization

#### Cranium Variance Function  
similar to the last one...
```{r}
get_cvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>%
        summarise(
           vcPC1 = (var(cPC1)   * 0.2041), 
           vcPC2 = (var(cPC2)   * 0.1479), 
           vcPC3 = (var(cPC3)   * 0.0644), 
           vcPC4 = (var(cPC4)   * 0.0604), 
           vcPC5 = (var(cPC5)   * 0.0434), 
           vcPC6 = (var(cPC6)   * 0.0381), 
           vcPC7 = (var(cPC7)   * 0.0367), 
           vcPC8 = (var(cPC8)   * 0.0334), 
           vcPC9 = (var(cPC9)   * 0.0302), 
           vcPC10 = (var(cPC10) * 0.0273), 
           vcPC11 = (var(cPC11) * 0.0233), 
           vcPC12 = (var(cPC12) * 0.0207), 
           vcPC13 = (var(cPC13) * 0.0179), 
           vcPC14 = (var(cPC14) * 0.0170), 
           vcPC15 = (var(cPC15) * 0.0162), 
           vcPC16 = (var(cPC16) * 0.0152), 
           vcPC17 = (var(cPC17) * 0.0142), 
           vcPC18 = (var(cPC18) * 0.0123), 
           vcPC19 = (var(cPC19) * 0.0117), 
           vcPC20 = (var(cPC20) * 0.0105), 
           vcPC21 = (var(cPC21) * 0.0098), 
           vcPC22 = (var(cPC22) * 0.0095), 
           vcPC23 = (var(cPC23) * 0.0090), 
           vcPC24 = (var(cPC24) * 0.0080), 
           vcPC25 = (var(cPC25) * 0.0078), 
           vcPC26 = (var(cPC26) * 0.0075), 
           vcPC27 = (var(cPC27) * 0.0072), 
           vcPC28 = (var(cPC28) * 0.0069), 
           vcPC29 = (var(cPC29) * 0.0063), 
           vcPC30 = (var(cPC30) * 0.0059), 
           vcPC31 = (var(cPC31) * 0.0054), 
           vcPC32 = (var(cPC32) * 0.0052), 
           vcPC33 = (var(cPC33) * 0.0051), 
           vcPC34 = (var(cPC34) * 0.0046),
           vcPC35 = (var(cPC35) * 0.0043),
           vcPC36 = (var(cPC36) * 0.0038),
           vcCsize = (var(cCsize)))) %>% 
    bind_rows() %>% 
    as_tibble() %>%
    mutate(vc = vcPC1 + vcPC2 + vcPC3 + vcPC4 + vcPC5 + vcPC6 + vcPC7 + vcPC8 + vcPC9 + vcPC10 + vcPC11 + vcPC12 + vcPC13 + vcPC14 + vcPC15 + vcPC16 + vcPC17 + vcPC18 + vcPC19 + vcPC20 + vcPC21 + vcPC22 + vcPC23 + vcPC24 + vcPC25 + vcPC26 + vcPC27 + vcPC28 + vcPC29 + vcPC30 + vcPC31 + vcPC32 + vcPC33 + vcPC34) %>%  
      select(vc, vcCsize) %>%
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```

#### Estimate simulated communities
Warning:: this may take hours depending on furrr & future settings. Using `workers = 6` on an Apple M1 takes about 4 minutes per community, or 36 min total.
```{r}
camb <- future_map(sp_amb, ~ get_cvar(.x, cdat, "Ambang"), chunks = 1000) %>% bind_rows()
cbaw <- future_map(sp_baw, ~ get_cvar(.x, cdat, "Bawakaraeng"), chunks = 1000) %>% bind_rows()
cbul <- future_map(sp_bul, ~ get_cvar(.x, cdat, "Buliohuto"), chunks = 1000) %>% bind_rows()
cdak <- future_map(sp_dak, ~ get_cvar(.x, cdat, "Dako"), chunks = 1000) %>% bind_rows()
cgan <- future_map(sp_gan, ~ get_cvar(.x, cdat, "Gandangdewata"), chunks = 1000) %>% bind_rows()
ckat <- future_map(sp_kat, ~ get_cvar(.x, cdat, "Katopasa"), chunks = 1000) %>% bind_rows()
clat <- future_map(sp_lat, ~ get_cvar(.x, cdat, "Latimojong"), chunks = 1000) %>% bind_rows()
cnok <- future_map(sp_nok, ~ get_cvar(.x, cdat, "Nokilalaki"), chunks = 1000) %>% bind_rows()
ctor <- future_map(sp_tor, ~ get_cvar(.x, cdat, "Torompupu"), chunks = 1000) %>% bind_rows()

c_rand <- bind_rows(camb, cbaw, cbul, cdak, cgan, ckat, clat, cnok, ctor) 
rm(camb, cbaw, cbul, cdak, cgan, ckat, clat, cnok, ctor)
```

# Cranium SES
```{r}
adat <- c_rand %>% group_by(com) %>% 
  summarise(vmean = mean(vc),
            vsd = sd(vc),
            vSmean = mean(vcCsize),
            vSsd = sd(vcCsize)) %>% 
  as.data.frame() %>% 
  right_join(adat, by="com") %>%
  mutate(ses_cv_wei =  (cv_wei - vmean) / vsd,
         ses_vcCsize =  (vcCsize - vSmean) / vSsd) %>% 
  select(!c(vmean, vsd, vSmean, vSsd))

#adat %>% write_csv("CLEAN_All_Traits.csv")
```


#### Add data to file
This is hashed out because it only should be done once, and data needs to be looked at to confirm that it is correct and safe to add. Definitely inspect before saving!!!
```{r}
#adat %>% write_csv("CLEAN_All_Traits.csv")
```


# Dentary Randomization

#### Dentary Randomization Function
```{r}
get_dvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>%
        summarise(vdPC1  = (var(dPC1)  * 0.2821), 
                  vdPC2  = (var(dPC2)  * 0.1529), 
                  vdPC3  = (var(dPC3)  * 0.1424), 
                  vdPC4  = (var(dPC4)  * 0.0693), 
                  vdPC5  = (var(dPC5)  * 0.0548), 
                  vdPC6  = (var(dPC6)  * 0.0393), 
                  vdPC7  = (var(dPC7)  * 0.0345), 
                  vdPC8  = (var(dPC8)  * 0.0269), 
                  vdPC9  = (var(dPC9)  * 0.0241), 
                  vdPC10 = (var(dPC10) * 0.0212), 
                  vdPC11 = (var(dPC11) * 0.0173), 
                  vdPC12 = (var(dPC12) * 0.0164), 
                  vdPC13 = (var(dPC13) * 0.0126), 
                  vdPC14 = (var(dPC14) * 0.0117), 
                  vdPC15 = (var(dPC15) * 0.0102), 
                  vdPC16 = (var(dPC16) * 0.0097), 
                  vdPC17 = (var(dPC17) * 0.0089), 
                  vdPC18 = (var(dPC18) * 0.0082), 
                  vdPC19 = (var(dPC19) * 0.0066), 
                  vdPC20 = (var(dPC20) * 0.0059),
                  vdCsize = var(dCsize))) %>%
    bind_rows() %>% 
    as_tibble() %>%
    mutate(vd = vdPC1 + vdPC2 + vdPC3 + vdPC4 + vdPC5 + vdPC6 + vdPC7 + vdPC8 + vdPC9 + vdPC10 + vdPC11 + vdPC12 + vdPC13 + vdPC14 + vdPC15 + vdPC16 + vdPC17 + vdPC18 + vdPC19 + vdPC20 ) %>%  
      select(vd, vdCsize) %>%
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```

```{r}
damb <- future_map(sp_amb, ~ get_dvar(.x, ddat, "Ambang"), chunks = 1000) %>% bind_rows()
dbaw <- future_map(sp_baw, ~ get_dvar(.x, ddat, "Bawakaraeng"), chunks = 1000) %>% bind_rows()
dbul <- future_map(sp_bul, ~ get_dvar(.x, ddat, "Buliohuto"), chunks = 1000) %>% bind_rows()
ddak <- future_map(sp_dak, ~ get_dvar(.x, ddat, "Dako"), chunks = 1000) %>% bind_rows()
dgan <- future_map(sp_gan, ~ get_dvar(.x, ddat, "Gandangdewata"), chunks = 1000) %>% bind_rows()
dkat <- future_map(sp_kat, ~ get_dvar(.x, ddat, "Katopasa"), chunks = 1000) %>% bind_rows()
dlat <- future_map(sp_lat, ~ get_dvar(.x, ddat, "Latimojong"), chunks = 1000) %>% bind_rows()
dnok <- future_map(sp_nok, ~ get_dvar(.x, ddat, "Nokilalaki"), chunks = 1000) %>% bind_rows()
dtor <- future_map(sp_tor, ~ get_dvar(.x, ddat, "Torompupu"), chunks = 1000) %>% bind_rows()

d_rand <- bind_rows(damb, dbaw, dbul, ddak, dgan, dkat, dlat, dnok, dtor) 
rm(damb, dbaw, dbul, ddak, dgan, dkat, dlat, dnok, dtor)
```
# Dentry SES
```{r}
adat <- d_rand %>% group_by(com) %>% 
  summarise(mean_d = mean(vd),
            sd_d = sd(vd),
            mean_sd = mean(vdCsize),
            sd_sd = sd(vdCsize)) %>% 
  as.data.frame() %>% 
  right_join(adat, by="com") %>%
  mutate(ses_dv_wei =  (dv_wei - mean_d) / sd_d,
         ses_vdCsize = (vdCsize - mean_sd) / sd_sd) %>% 
  select(!c(mean_d, sd_d, mean_sd, sd_sd))
```

```{r}
#adat %>% write_csv("CLEAN_All_Traits.csv")
```



# Skull Shape Randomization

## Skull Variance
Really Big Function

```{r}
get_skvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>% summarise(
                  vdPC1  = (var(dPC1, na.rm = T)  * 0.2821), 
                  vdPC2  = (var(dPC2, na.rm = T)  * 0.1529), 
                  vdPC3  = (var(dPC3, na.rm = T)  * 0.1424), 
                  vdPC4  = (var(dPC4, na.rm = T)  * 0.0693), 
                  vdPC5  = (var(dPC5, na.rm = T)  * 0.0548), 
                  vdPC6  = (var(dPC6, na.rm = T)  * 0.0393), 
                  vdPC7  = (var(dPC7, na.rm = T)  * 0.0345), 
                  vdPC8  = (var(dPC8, na.rm = T)  * 0.0269), 
                  vdPC9  = (var(dPC9, na.rm = T)  * 0.0241), 
                  vdPC10 = (var(dPC10, na.rm = T) * 0.0212), 
                  vdPC11 = (var(dPC11, na.rm = T) * 0.0173), 
                  vdPC12 = (var(dPC12, na.rm = T) * 0.0164), 
                  vdPC13 = (var(dPC13, na.rm = T) * 0.0126), 
                  vdPC14 = (var(dPC14, na.rm = T) * 0.0117), 
                  vdPC15 = (var(dPC15, na.rm = T) * 0.0102), 
                  vdPC16 = (var(dPC16, na.rm = T) * 0.0097), 
                  vdPC17 = (var(dPC17, na.rm = T) * 0.0089), 
                  vdPC18 = (var(dPC18, na.rm = T) * 0.0082), 
                  vdPC19 = (var(dPC19, na.rm = T) * 0.0066), 
                  vdPC20 = (var(dPC20, na.rm = T) * 0.0059),
                  vcPC1 = (var(cPC1, na.rm = T)   * 0.2041), 
                  vcPC2 = (var(cPC2, na.rm = T)   * 0.1479), 
                  vcPC3 = (var(cPC3, na.rm = T)   * 0.0644), 
                  vcPC4 = (var(cPC4, na.rm = T)   * 0.0604), 
                  vcPC5 = (var(cPC5, na.rm = T)   * 0.0434), 
                  vcPC6 = (var(cPC6, na.rm = T)   * 0.0381), 
                  vcPC7 = (var(cPC7, na.rm = T)   * 0.0367), 
                  vcPC8 = (var(cPC8, na.rm = T)   * 0.0334), 
                  vcPC9 = (var(cPC9, na.rm = T)   * 0.0302), 
                  vcPC10 = (var(cPC10, na.rm = T) * 0.0273), 
                  vcPC11 = (var(cPC11, na.rm = T) * 0.0233), 
                  vcPC12 = (var(cPC12, na.rm = T) * 0.0207), 
                  vcPC13 = (var(cPC13, na.rm = T) * 0.0179), 
                  vcPC14 = (var(cPC14, na.rm = T) * 0.0170), 
                  vcPC15 = (var(cPC15, na.rm = T) * 0.0162), 
                  vcPC16 = (var(cPC16, na.rm = T) * 0.0152), 
                  vcPC17 = (var(cPC17, na.rm = T) * 0.0142), 
                  vcPC18 = (var(cPC18, na.rm = T) * 0.0123), 
                  vcPC19 = (var(cPC19, na.rm = T) * 0.0117), 
                  vcPC20 = (var(cPC20, na.rm = T) * 0.0105), 
                  vcPC21 = (var(cPC21, na.rm = T) * 0.0098), 
                  vcPC22 = (var(cPC22, na.rm = T) * 0.0095), 
                  vcPC23 = (var(cPC23, na.rm = T) * 0.0090), 
                  vcPC24 = (var(cPC24, na.rm = T) * 0.0080), 
                  vcPC25 = (var(cPC25, na.rm = T) * 0.0078), 
                  vcPC26 = (var(cPC26, na.rm = T) * 0.0075), 
                  vcPC27 = (var(cPC27, na.rm = T) * 0.0072), 
                  vcPC28 = (var(cPC28, na.rm = T) * 0.0069), 
                  vcPC29 = (var(cPC29, na.rm = T) * 0.0063), 
                  vcPC30 = (var(cPC30, na.rm = T) * 0.0059), 
                  vcPC31 = (var(cPC31, na.rm = T) * 0.0054), 
                  vcPC32 = (var(cPC32, na.rm = T) * 0.0052), 
                  vcPC33 = (var(cPC33, na.rm = T) * 0.0051), 
                  vcPC34 = (var(cPC34, na.rm = T) * 0.0046),
                  vcPC35 = (var(cPC35, na.rm = T) * 0.0043),
                  vcPC36 = (var(cPC36, na.rm = T) * 0.0038))) %>%
    bind_rows() %>% 
    as_tibble() %>%
    mutate(vd = vdPC1 + vdPC2 + vdPC3 + vdPC4 + vdPC5 + vdPC6 + vdPC7 + vdPC8 + vdPC9 + vdPC10 + vdPC11 + vdPC12 + vdPC13 + vdPC14 + vdPC15 + vdPC16 + vdPC17 + vdPC18 + vdPC19 + vdPC20,
           vc = vcPC1 + vcPC2 + vcPC3 + vcPC4 + vcPC5 + vcPC6 + vcPC7 + vcPC8 + vcPC9 + vcPC10 + vcPC11 + vcPC12 + vcPC13 + vcPC14 + vcPC15 + vcPC16 + vcPC17 + vcPC18 + vcPC19 + vcPC20 + vcPC21 + vcPC22 + vcPC23 + vcPC24 + vcPC25 + vcPC26 + vcPC27 + vcPC28 + vcPC29 + vcPC30 + vcPC31 + vcPC32 + vcPC33 + vcPC34 + vcPC35 + vcPC36) %>% 
    mutate(vsk = (vd + vc) / 2) %>%  
      select(vsk) %>%
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```



```{r}
skamb <- future_map(sp_amb, ~ get_skvar(.x, skdat, "Ambang"), chunks = 1000) %>% bind_rows()
skbaw <- future_map(sp_baw, ~ get_skvar(.x, skdat, "Bawakaraeng"), chunks = 1000) %>% bind_rows()
skbul <- future_map(sp_bul, ~ get_skvar(.x, skdat, "Buliohuto"), chunks = 1000) %>% bind_rows()
skdak <- future_map(sp_dak, ~ get_skvar(.x, skdat, "Dako"), chunks = 1000) %>% bind_rows()
skgan <- future_map(sp_gan, ~ get_skvar(.x, skdat, "Gandangdewata"), chunks = 1000) %>% bind_rows()
skkat <- future_map(sp_kat, ~ get_skvar(.x, skdat, "Katopasa"), chunks = 1000) %>% bind_rows()
sklat <- future_map(sp_lat, ~ get_skvar(.x, skdat, "Latimojong"), chunks = 1000) %>% bind_rows()
sknok <- future_map(sp_nok, ~ get_skvar(.x, skdat, "Nokilalaki"), chunks = 1000) %>% bind_rows()
sktor <- future_map(sp_tor, ~ get_skvar(.x, skdat, "Torompupu"), chunks = 1000) %>% bind_rows()

sk_rand <- bind_rows(skamb, skbaw, skbul, skdak, skgan, skkat, sklat, sknok, sktor) 
rm(skamb, skbaw, skbul, skdak, skgan, skkat, sklat, sknok, sktor)

```

## Skull SES

```{r}

adat <- sk_rand %>% group_by(com) %>% 
  summarise(mean = mean(vsk),
            sd = sd(vsk)) %>% 
  as.data.frame() %>% 
  right_join(adat, by="com") %>%
  mutate(ses_vsk =  (((cv_wei + dv_wei)/2) - mean) / sd) %>% 
  select(!c(mean, sd))

```

```{r}
#adat %>% write_csv("CLEAN_All_Traits.csv")
```


# Morpho Randomization

#### Morpho Randomiation Function
vMass + vEar + vHF + vTail + vHB + dv_wei + cv_wei 
I had to change the summarise calculations to include the `na.rm = TRUE` bit so that they would calculate vc and vd with the species are included in ext measurements and not cranial/dent.
```{r}
get_mvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>%
        summarise(.,
            vcPC1 =  var(cPC1 , na.rm = TRUE) * 0.2041, 
            vcPC2 =  var(cPC2 , na.rm = TRUE) * 0.1479, 
            vcPC3 =  var(cPC3 , na.rm = TRUE) * 0.0644, 
            vcPC4 =  var(cPC4 , na.rm = TRUE) * 0.0604, 
            vcPC5 =  var(cPC5 , na.rm = TRUE) * 0.0434, 
            vcPC6 =  var(cPC6 , na.rm = TRUE) * 0.0381, 
            vcPC7 =  var(cPC7 , na.rm = TRUE) * 0.0367, 
            vcPC8 =  var(cPC8 , na.rm = TRUE) * 0.0334, 
            vcPC9 =  var(cPC9 , na.rm = TRUE) * 0.0302, 
            vcPC10 = var(cPC10, na.rm = TRUE) * 0.0273, 
            vcPC11 = var(cPC11, na.rm = TRUE) * 0.0233, 
            vcPC12 = var(cPC12, na.rm = TRUE) * 0.0207, 
            vcPC13 = var(cPC13, na.rm = TRUE) * 0.0179, 
            vcPC14 = var(cPC14, na.rm = TRUE) * 0.0170, 
            vcPC15 = var(cPC15, na.rm = TRUE) * 0.0162, 
            vcPC16 = var(cPC16, na.rm = TRUE) * 0.0152, 
            vcPC17 = var(cPC17, na.rm = TRUE) * 0.0142, 
            vcPC18 = var(cPC18, na.rm = TRUE) * 0.0123, 
            vcPC19 = var(cPC19, na.rm = TRUE) * 0.0117, 
            vcPC20 = var(cPC20, na.rm = TRUE) * 0.0105, 
            vcPC21 = var(cPC21, na.rm = TRUE) * 0.0098, 
            vcPC22 = var(cPC22, na.rm = TRUE) * 0.0095, 
            vcPC23 = var(cPC23, na.rm = TRUE) * 0.0090, 
            vcPC24 = var(cPC24, na.rm = TRUE) * 0.0080, 
            vcPC25 = var(cPC25, na.rm = TRUE) * 0.0078, 
            vcPC26 = var(cPC26, na.rm = TRUE) * 0.0075, 
            vcPC27 = var(cPC27, na.rm = TRUE) * 0.0072, 
            vcPC28 = var(cPC28, na.rm = TRUE) * 0.0069, 
            vcPC29 = var(cPC29, na.rm = TRUE) * 0.0063, 
            vcPC30 = var(cPC30, na.rm = TRUE) * 0.0059, 
            vcPC31 = var(cPC31, na.rm = TRUE) * 0.0054, 
            vcPC32 = var(cPC32, na.rm = TRUE) * 0.0052, 
            vcPC33 = var(cPC33, na.rm = TRUE) * 0.0051, 
            vcPC34 = var(cPC34, na.rm = TRUE) * 0.0046,
            vcPC35 = var(cPC36, na.rm = TRUE) * 0.0043,
            vcPC35 = var(cPC36, na.rm = TRUE) * 0.0038,
            #vcCsize = var(cCsize, na.rm = TRUE),
            vdPC1  = var(dPC1 , na.rm = TRUE) * 0.2821, 
            vdPC2  = var(dPC2 , na.rm = TRUE) * 0.1529, 
            vdPC3  = var(dPC3 , na.rm = TRUE) * 0.1424, 
            vdPC4  = var(dPC4 , na.rm = TRUE) * 0.0693, 
            vdPC5  = var(dPC5 , na.rm = TRUE) * 0.0548, 
            vdPC6  = var(dPC6 , na.rm = TRUE) * 0.0393, 
            vdPC7  = var(dPC7 , na.rm = TRUE) * 0.0345, 
            vdPC8  = var(dPC8 , na.rm = TRUE) * 0.0269, 
            vdPC9  = var(dPC9 , na.rm = TRUE) * 0.0241, 
            vdPC10 = var(dPC10, na.rm = TRUE) * 0.0212, 
            vdPC11 = var(dPC11, na.rm = TRUE) * 0.0173, 
            vdPC12 = var(dPC12, na.rm = TRUE) * 0.0164, 
            vdPC13 = var(dPC13, na.rm = TRUE) * 0.0126, 
            vdPC14 = var(dPC14, na.rm = TRUE) * 0.0117, 
            vdPC15 = var(dPC15, na.rm = TRUE) * 0.0102, 
            vdPC16 = var(dPC16, na.rm = TRUE) * 0.0097, 
            vdPC17 = var(dPC17, na.rm = TRUE) * 0.0089, 
            vdPC18 = var(dPC18, na.rm = TRUE) * 0.0082, 
            vdPC19 = var(dPC19, na.rm = TRUE) * 0.0066, 
            vdPC20 = var(dPC20, na.rm = TRUE) * 0.0059,
            #vdCsize = var(dCsize, na.rm = TRUE),
            vHB =     var(HB, na.rm = TRUE), 
            vHF =     var(rHF, na.rm = TRUE), 
            vTail =   var(rTail, na.rm = TRUE), 
            vEar =    var(rEar, na.rm = TRUE),
            vMass =   var(lMass, na.rm = TRUE))) %>%
    bind_rows() %>% 
    as_tibble() %>%
    mutate(vc = vcPC1 + vcPC2 + vcPC3 + vcPC4 + vcPC5 + vcPC6 + vcPC7 + vcPC8 + vcPC9 + vcPC10 + vcPC11 + vcPC12 + vcPC13 + vcPC14 + vcPC15 + vcPC16 + vcPC17 + vcPC18 + vcPC19 + vcPC20 + vcPC21 + vcPC22 + vcPC23 + vcPC24 + vcPC25 + vcPC26 + vcPC27 + vcPC28 + vcPC29 + vcPC30 + vcPC31 + vcPC32 + vcPC33 + vcPC34,
           vd = vdPC1 + vdPC2 + vdPC3 + vdPC4 + vdPC5 + vdPC6 + vdPC7 + vdPC8 + vdPC9 + vdPC10 + vdPC11 + vdPC12 + vdPC13 + vdPC14 + vdPC15 + vdPC16 + vdPC17 + vdPC18 + vdPC19 + vdPC20) %>% 
      mutate(vMorpho = (vMass + vEar + vHF + vTail + vHB + vc + vd ) / 7) %>% 
      select(vMorpho) %>%
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```


## Morpho Calculations 

```{r}
mamb <- future_map(sp_amb, ~ get_mvar(.x, mdat, "Ambang"), chunks = 1000) %>% bind_rows()
mbaw <- future_map(sp_baw, ~ get_mvar(.x, mdat, "Bawakaraeng"), chunks = 1000) %>% bind_rows()
mbul <- future_map(sp_bul, ~ get_mvar(.x, mdat, "Buliohuto"), chunks = 1000) %>% bind_rows()
mdak <- future_map(sp_dak, ~ get_mvar(.x, mdat, "Dako"), chunks = 1000) %>% bind_rows()
mgan <- future_map(sp_gan, ~ get_mvar(.x, mdat, "Gandangdewata"), chunks = 1000) %>% bind_rows()
mkat <- future_map(sp_kat, ~ get_mvar(.x, mdat, "Katopasa"), chunks = 1000) %>% bind_rows()
mlat <- future_map(sp_lat, ~ get_mvar(.x, mdat, "Latimojong"), chunks = 1000) %>% bind_rows()
mnok <- future_map(sp_nok, ~ get_mvar(.x, mdat, "Nokilalaki"), chunks = 1000) %>% bind_rows()
mtor <- future_map(sp_tor, ~ get_mvar(.x, mdat, "Torompupu"), chunks = 1000) %>% bind_rows()

m_rand <- bind_rows(mamb, mbaw, mbul, mdak, mgan, mkat, mlat, mnok, mtor) 

rm(mamb, mbaw, mbul, mdak, mgan, mkat, mlat, mnok, mtor)

```
############# 


#### Morpho SES
```{r}
adat <- m_rand %>% group_by(com) %>% 
  summarise(mean = mean(vMorpho),
            sd = sd(vMorpho)) %>% 
  as.data.frame() %>% 
  right_join(adat, by="com") %>%
  mutate(ses_morpho =  (((cv_wei + dv_wei + vMass + vEar + vHF + vTail + vHB)/ 7) - mean) / sd) %>% 
  select(!c(mean, sd))

```

#### Add Data to file
```{r}
adat <- adat %>% bind_cols(morpho_dat)

#adat %>% write_csv("CLEAN_All_Traits.csv")

rm(camb, cbaw, cbul, cdak, ckat, cgan, clat, cnok, ctor, c_rand)
```

# Locomotion Randomization
```{r}
locdat <- read_csv("Locomotion_Data/Locomotion_List.csv")
locvar <- read_csv("Locomotion_Data/All_Locomotor_var.csv")
```

#### Locomotion Randomization Function
```{r}
get_lvar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
    select(!Species) %>% 
    summarise(vLoc = var(Loc)) %>%
    as_tibble() %>% 
    add_column(com = {{mountain}})
}
```


```{r}
lamb <- map(sp_amb, ~ get_lvar(.x, locdat, "Ambang")) %>% bind_rows()
lbaw <- map(sp_baw, ~ get_lvar(.x, locdat, "Bawakaraeng")) %>% bind_rows()
lbul <- map(sp_bul, ~ get_lvar(.x, locdat, "Buliohuto")) %>% bind_rows()
ldak <- map(sp_dak, ~ get_lvar(.x, locdat, "Dako")) %>% bind_rows()
lgan <- map(sp_gan, ~ get_lvar(.x, locdat, "Gandangdewata")) %>% bind_rows()
lkat <- map(sp_kat, ~ get_lvar(.x, locdat, "Katopasa")) %>% bind_rows()
llat <- map(sp_lat, ~ get_lvar(.x, locdat, "Latimojong")) %>% bind_rows()
lnok <- map(sp_nok, ~ get_lvar(.x, locdat, "Nokilalaki")) %>% bind_rows()
ltor <- map(sp_tor, ~ get_lvar(.x, locdat, "Torompupu")) %>% bind_rows()

l_rand <- bind_rows(lamb, lbaw, lbul, ldak, lgan, lkat, llat, lnok, ltor) 

df5 <- 
l_rand %>% 
  group_by(com) %>% 
  summarise(m = mean(vLoc),
            sd = sd(vLoc)) %>% 
  as.data.frame()
```

Simple calculations!
```{r}
df5$var = locvar$vloc
df5$ses_loc_prob = ((df5$var - df5$m) / df5$sd)
locvar$ses_loc_prob = df5$ses_loc_prob
write_csv(locvar, "Locomotion_Data/All_Locomotor_var.csv")
```

```{r}
  locvar %>% 
  ggplot(aes(y = ses_loc_prob, x = nspec, color = com)) +
 geom_point(size = 8) +
  theme_bw() + scale_color_viridis_d(direction = -1, begin = 0, end = 0.95) + guides(color = guide_legend(reverse=T)) + theme(legend.position = "none") 

```

# Isotope Randomization

#### Isotope Randomization function


```{r}
get_ivar <- function(sp, data, mountain) {
  data %>% 
    filter(Species %in% {{sp}}) %>% 
  split(.$.draw) %>% 
  map(., ~ .x[ ,-c(1:2)]) %>% 
  map(~ .x %>%
        summarise(
            vC13 = var(sC13), 
            vN15 = var(sN15), 
            vIso = (var(sC13) +  var(sN15)) / 2)) %>%
  bind_rows() %>% 
  as_tibble() %>% 
  sample_n(., size = 100) %>% 
    add_column(com = {{mountain}})
}
```

```{r}
iamb <- future_map(sp_amb, ~ get_ivar(.x, ifit, "Ambang"       ), chunks = 1000) %>% bind_rows()
ibaw <- future_map(sp_baw, ~ get_ivar(.x, ifit, "Bawakaraeng"  ), chunks = 1000) %>% bind_rows()
ibul <- future_map(sp_bul, ~ get_ivar(.x, ifit, "Buliohuto"    ), chunks = 1000) %>% bind_rows()
idak <- future_map(sp_dak, ~ get_ivar(.x, ifit, "Dako"         ), chunks = 1000) %>% bind_rows()
igan <- future_map(sp_gan, ~ get_ivar(.x, ifit, "Gandangdewata"), chunks = 1000) %>% bind_rows()
ilat <- future_map(sp_lat, ~ get_ivar(.x, ifit, "Latimojong"   ), chunks = 1000) %>% bind_rows()

i_rand <- bind_rows(iamb, ibaw, ibul, idak, igan, ilat) 

df2 <- 
i_rand %>% 
  group_by(com) %>% 
  summarise(mC = mean(vC13),
            sdC = sd(vC13),
            mN = mean(vN15),
            sdN = sd(vN15),
            mI = mean(vIso),
            sdI = sd(vIso)) %>% 
  as.data.frame()
```

#### Add Data to FIle
hashed out, only needs to be done once
and be careful before saving
CHECK HERE AND ADD ISO TO ADAT
```{r}
iso_dat$.draw = rep(1:4000, 6)

adat <- adat %>%  
  select(!c(ses_vC13_group, ses_vN15_group, ses_vIso_group)) %>%
  full_join(iso_dat, by = c(".draw", "com"))


 #adat  %>% 
 #write_csv("All_Traits.csv")

```

# Isotope SES
## Using MEAN values from community multilevel model for each community
#### USE THESE VALUES
```{r}
idat <- adat %>% 
  select(vC13_group, vN15_group, iso_var_group, com) 

sesamb  <- idat %>% 
  filter(com == "Ambang") %>% 
  mutate(ses_vC13_group =  (vC13_group      - df2[1,2] ) / df2[1,3] ,
         ses_vN15_group =  (vN15_group      - df2[1,4] ) / df2[1,5]  ,
         ses_vIso_group =  (iso_var_group   - df2[1,6] ) / df2[1,7]  )

sesbaw  <- idat %>% 
  filter(com == "Bawakaraeng") %>% 
  mutate(ses_vC13_group =  (vC13_group      - df2[2,2] ) / df2[2,3] ,
         ses_vN15_group =  (vN15_group      - df2[2,4] ) / df2[2,5]  ,
         ses_vIso_group =  (iso_var_group   - df2[2,6] ) / df2[2,7]  )

sesbul  <- idat %>% 
  filter(com == "Buliohuto") %>% 
  mutate(ses_vC13_group =  (vC13_group      - df2[3,2] ) / df2[3,3] ,
         ses_vN15_group =  (vN15_group      - df2[3,4] ) / df2[3,5]  ,
         ses_vIso_group =  (iso_var_group   - df2[3,6] ) / df2[3,7]  )

sesdak  <- idat %>% 
  filter(com == "Dako") %>% 
  mutate(ses_vC13_group =  (vC13_group      - df2[4,2] ) / df2[4,3] ,
         ses_vN15_group =  (vN15_group      - df2[4,4] ) / df2[4,5]  ,
         ses_vIso_group =  (iso_var_group   - df2[4,6] ) / df2[4,7]  )

sesgan  <- idat %>% 
  filter(com == "Gandangdewata") %>% 
  mutate(ses_vC13_group =  (vC13_group      - df2[5,2] ) / df2[5,3] ,
         ses_vN15_group =  (vN15_group      - df2[5,4] ) / df2[5,5]  ,
         ses_vIso_group =  (iso_var_group   - df2[5,6] ) / df2[5,7]  )

seslat  <- idat %>% 
  filter(com == "Latimojong") %>% 
  mutate(ses_vC13_group =  (vC13_group     - df2[6,2] ) / df2[6,3] ,
         ses_vN15_group =  (vN15_group     - df2[6,4] ) / df2[6,5]  ,
         ses_vIso_group =  (iso_var_group  - df2[6,6] ) / df2[6,7]  )
  
iso_dat <- 
  bind_rows(sesamb, sesbaw, sesbul, sesdak, sesgan, seslat) %>% 
  select(c(ses_vC13_group, ses_vN15_group, ses_vIso_group, com))

```


#### Add Data to FIle
hashed out, only needs to be done once
and be careful before saving
CHECK HERE AND ADD ISO TO ADAT
```{r}
iso_dat2$.draw = rep(1:4000, 6)

adat <- adat %>%  
  #select(!c(ses_vC13_group, ses_vN15_group, ses_vIso_group)) %>%
  full_join(iso_dat2, by = c(".draw", "com"))


 adat  %>% 
 write_csv("All_Traits.csv")

```




# Test Plot
#### Test_Plot Function
```{r}
ses_plot <- function(data, x, title) {
  data %>% 
    filter({{x}} > -4) %>%  
    filter({{x}} < 4) %>% 
  mutate(com = factor(com, level = level_order)) %>% 
  ggplot(aes(y = factor(com, level = level_order), x = {{x}}, fill = com)) +
  stat_halfeye(.width = c(0.74, 0.89),  alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_vline(xintercept = -1.96, linetype = 3) +
  geom_vline(xintercept = 1.96, linetype = 3) +
   labs(title={{title}}, x="Standard Effect Size", y = "", fill = "Mountain") +
    xlim(c(-4, 4)) + 
  theme_bw() + scale_fill_viridis_d(direction = -1, begin = 0, end = 0.9, option = "A") + guides(fill = guide_legend(reverse=T)) + theme(legend.position = "none") 
}
```


```{r}
ses_plot(adat, ses_vHB, "Head Body")
```