---
title: "Positions"
---

# Estimate the differences in the location of space occupation

This script estimates the location of traits in the communities by estimating the mean of each community for each trait.

This method will have commonalities with the density and variance scripts. The analyses will be univariate. For the shapes, we will focus just on the "significant" PCs based on the broken stick method. 

Load packages and data and functions Most of these are different species lists.

```{r}
pacman::p_load(here, tidyverse, tidybayes, brms, modelr, furrr, dispRity, patchwork, paletteer)


#List of species by community
load(here("Species_Data", "Species_Lists.Rdata"))
#List of all species
load(here("Species_Data", "Species_Extant.RData"))

scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)
level_order <-  c( 'Bawakaraeng', 'Buliohuto','Dako', "Katopasa", "Ambang", "Latimojong", "Torompupu", "Nokilalaki", "Gandangdewata")
level_order_iso <-  c( 'Bawakaraeng', 'Buliohuto','Dako',  "Ambang", "Latimojong",  "Gandangdewata")

adat <- read_csv(here("All_Traits.csv"))
```

These scripts use the package `furrr` which is a multi-threading version of `purrr`. It incorperates the `futures` package to run on as many cores as you choose. Here I am selecting 6 cores on my laptop.

```{r}
furrr_options(seed = TRUE)
options(future.rng.onMisuse="ignore")
options(readr.show_col_types = FALSE)
plan(multisession, workers = 6)
```

## Cranial Positions

Load the necessary data

```{r}
cdat <- read_csv(here("Cranial_Data", "Cranial_36axes_Fitted.csv"))

pdat <- read_csv(here("Cranial_Data", "Cranial_PCA_Data_36axes.csv")) %>% 
  mutate(Csize = scale2(Csize)) %>% 
  group_by(Species) %>% 
  summarise_at(vars(PC1:PC3, Csize), mean) %>% 
  ungroup()

ambt <- pdat %>% filter(Species %in% spamb) %>% 
  mutate(com = "Ambang")
bawt <- pdat %>% filter(Species %in% spbaw)  %>% 
  mutate(com = "Bawakaraeng")
bult <- pdat %>% filter(Species %in% spbul)  %>% 
  mutate(com = "Buliohuto")
dakt <- pdat %>% filter(Species %in% spdak) %>% 
  mutate(com = "Dako")
gant <- pdat %>% filter(Species %in% spgan) %>% 
  mutate(com = "Gandangdewata")
katt <- pdat %>% filter(Species %in% spkat) %>% 
  mutate(com = "Katopasa")
latt <- pdat %>% filter(Species %in% splat) %>% 
  mutate(com = "Latimojong")
nokt <- pdat %>% filter(Species %in% spnok) %>% 
  mutate(com = "Nokilalaki")
tort <- pdat %>% filter(Species %in% sptor) %>% 
  mutate(com = "Torompupu")

pdat <- bind_rows(ambt, bawt, bult, dakt, gant, katt, latt, nokt, tort) %>% 
  rename_with(~ gsub("PC", "cPC", .x))

```

### Cranial Position Estimate

Estimate Cranial Shape Nearest Neighbor for each community

```{r}
## Cranium Variace and Volumes By Community

get_cran <- function(sp, data, mountain) {
  data %>%
    filter(Species %in% {{sp}}) %>%
    select(!Species) %>%
    select(!.row) %>%
    group_by(.draw) %>% 
    summarise_at(vars(cPC1:cPC3, cCsize), mean) %>% 
    select(.draw, cPC1, cPC2, cPC3, cCsize) %>% 
    add_column(com = {{mountain}})
}


cambt <- get_cran(spamb, cdat, "Ambang")
cbawt <- get_cran(spbaw, cdat, "Bawakaraeng") 
cbult <- get_cran(spbul, cdat, "Buliohuto") 
cdakt <- get_cran(spdak, cdat, "Dako")
cgant <- get_cran(spgan, cdat, "Gandangdewata")
ckatt <- get_cran(spkat, cdat, "Katopasa")
clatt <- get_cran(splat, cdat, "Latimojong")
cnokt <- get_cran(spnok, cdat, "Nokilalaki")
ctort <- get_cran(sptor, cdat, "Torompupu")

cct <- bind_rows(cambt, cbawt, cbult, cdakt, cgant, ckatt, clatt, cnokt, ctort) 
rm(cambt, cbawt, cbult, cdakt, cgant, ckatt, clatt, cnokt, ctort)
#write_csv(cct, here("Cranial_Data","Community_Cranial_Variance_Weighted.csv"))
```


#### Quick Plot
```{r}
#cct %>% mutate(cv_wei = (cv_wei / 36)) %>% 
cct %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes(y = com, x = cPC1)) +
  stat_halfeye(.width = c(0.74, 0.89),  alpha = 0.7) +
  # Add points
  geom_point(aes(x = cPC1, y = com), data = pdat) +
  labs(title="Cranial Shape Position",x="PC1 Mean", y = "", fill = "Mountain") +
  geom_vline(xintercept = 0, linetype = 2) +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) + theme(legend.position = "none")
```

```{r}
cct %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes( x = cPC1, y = cPC2, color = com)) +
  #geom_density_2d(bins =5, contour_var = "ndensity") +
  # Add points
  geom_jitter(aes(x = cPC1, y = cPC2, size = Csize), data = pdat, width = 0.002, height = 0.002) +
  scale_size(range = c(0.5, 5)) +
  geom_point(size = 8, alpha = 0.01) +
  #labs(title="Cranial Shape Position",x="PC1 Mean", y = "", fill = "Mountain") +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) #+ 
  #theme(legend.position = "none")
```

this is very cool! Most of the extreme shape variation is coming in smaller-bodied species. The size axis is largely filled among the communities, but the shape axis expands. 



# Dentary Position

```{r}
ddat <- read_csv(here("Dentary_Data", "Dentary_20axes_Fitted.csv"))

pddat <- read_csv(here("Dentary_Data", "Dentary_PCA_Data_20axes.csv")) %>% 
  mutate(Csize = scale2(Csize)) %>% 
  group_by(Species) %>% 
  summarise_at(vars(PC1:PC3, Csize), mean) %>% 
  ungroup()

ambt <- pddat %>% filter(Species %in% spamb) %>% 
  mutate(com = "Ambang")
bawt <- pddat %>% filter(Species %in% spbaw)  %>% 
  mutate(com = "Bawakaraeng")
bult <- pddat %>% filter(Species %in% spbul)  %>% 
  mutate(com = "Buliohuto")
dakt <- pddat %>% filter(Species %in% spdak) %>% 
  mutate(com = "Dako")
gant <- pddat %>% filter(Species %in% spgan) %>% 
  mutate(com = "Gandangdewata")
katt <- pddat %>% filter(Species %in% spkat) %>% 
  mutate(com = "Katopasa")
latt <- pddat %>% filter(Species %in% splat) %>% 
  mutate(com = "Latimojong")
nokt <- pddat %>% filter(Species %in% spnok) %>% 
  mutate(com = "Nokilalaki")
tort <- pddat %>% filter(Species %in% sptor) %>% 
  mutate(com = "Torompupu")

pddat <- bind_rows(ambt, bawt, bult, dakt, gant, katt, latt, nokt, tort) %>% 
  rename_with(~ gsub("PC", "dPC", .x)) %>% 
  mutate(com = factor(com, level = level_order))
  

```


#### Dentary Position Estimate


```{r}
get_dent <- function(sp, data, mountain) {
data %>% 
  filter(Species %in% {{sp}}) %>%
  select(!Species) %>%
  select(!.row) %>%
  group_by(.draw) %>%
    summarise_at(vars(dPC1:dPC3, dCsize), mean) %>% 
    select(.draw, dPC1, dPC2, dPC3, dCsize) %>% 
    add_column(com = {{mountain}})
}

dambt <- get_dent(spamb, ddat, "Ambang")
dbawt <- get_dent(spbaw, ddat, "Bawakaraeng") 
dbult <- get_dent(spbul, ddat, "Buliohuto") 
ddakt <- get_dent(spdak, ddat, "Dako")
dgant <- get_dent(spgan, ddat, "Gandangdewata")
dkatt <- get_dent(spkat, ddat, "Katopasa")
dlatt <- get_dent(splat, ddat, "Latimojong")
dnokt <- get_dent(spnok, ddat, "Nokilalaki")
dtort <- get_dent(sptor, ddat, "Torompupu")

dct <- bind_rows(dambt, dbawt, dbult, ddakt, dgant, dkatt, dlatt, dnokt, dtort) 

rm(dambt, dbawt, dbult, ddakt, dgant, dkatt, dlatt, dnokt, dtort)
```

Very similar to cranial!

#### Quick Plot
```{r}
dct %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes(y = com, x = dPC2)) +
  stat_halfeye(.width = c(0.74, 0.89),  alpha = 0.7) +
  # Add points
  geom_point(aes(x = dPC2, y = com), data = pddat) +
  labs(title="Dentary Shape Position",x="PC1 Mean", y = "", fill = "Mountain") +
  geom_vline(xintercept = 0, linetype = 2) +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) + theme(legend.position = "none")
```

```{r}
dct %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes( x = dPC1, y = dPC2, color = com)) +
  #geom_density_2d(bins =5, contour_var = "ndensity") +
  # Add points
  geom_jitter(aes(x = dPC1, y = dPC2, size = Csize), data = pddat, width = 0.002, height = 0.002) +
  scale_size(range = c(0.5, 5)) +
  geom_point(size = 8, alpha = 0.01) +
  #labs(title="Cranial Shape Position",x="PC1 Mean", y = "", fill = "Mountain") +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) #+ 
  #theme(legend.position = "none")
```

this is very cool! Most of the extreme shape variation is coming in smaller-bodied species. The size axis is largely filled among the communities, but the shape axis expands. 



# External Measurements

```{r}
edat <- read_csv(here("External_Measurement_Data", "External_Fitted.csv"))

extdat <- read_csv(here("External_Measurement_Data", "Measurement_Data_Museum.csv")) %>% 
  mutate(loc_state = as_factor(loc_state),
         lMass = log(Mass),
         rHF = HF / HB,
         rEar = Ear / HB,
         rTail = Tail / Total) %>% 
  mutate_if(is.numeric, scale2, na.rm = TRUE) %>% 
  group_by(Species) %>% 
  summarise_at(vars(HB, lMass:rTail), mean) %>% 
  ungroup()

ambt <- extdat %>% filter(Species %in% spamb) %>% 
  mutate(com = "Ambang")
bawt <- extdat %>% filter(Species %in% spbaw)  %>% 
  mutate(com = "Bawakaraeng")
bult <- extdat %>% filter(Species %in% spbul)  %>% 
  mutate(com = "Buliohuto")
dakt <- extdat %>% filter(Species %in% spdak) %>% 
  mutate(com = "Dako")
gant <- extdat %>% filter(Species %in% spgan) %>% 
  mutate(com = "Gandangdewata")
katt <- extdat %>% filter(Species %in% spkat) %>% 
  mutate(com = "Katopasa")
latt <- extdat %>% filter(Species %in% splat) %>% 
  mutate(com = "Latimojong")
nokt <- extdat %>% filter(Species %in% spnok) %>% 
  mutate(com = "Nokilalaki")
tort <- extdat %>% filter(Species %in% sptor) %>% 
  mutate(com = "Torompupu")

extdat <- bind_rows(ambt, bawt, bult, dakt, gant, katt, latt, nokt, tort) %>% 
  mutate(com = factor(com, level = level_order))
```

## Ext Position Estimate

```{r}
get_ext <- function(sp, data, mountain) {
data %>% 
  filter(Species %in% {{sp}}) %>%
  select(!Species) %>%
  select(!.row) %>%
  group_by(.draw) %>%  
  summarise(
            #ADDING IN MEAN HERE TO TEST FOR CHANGES IN POSTION
            #NOT SURE IF IT WORKS OR I WANT TO KEEP IT
            mHB = mean(HB),
            mTail = mean(rTail),
            mHF = mean(rHF),
            mEar = mean(rEar),
            mMass = mean(lMass)) %>% 
  add_column(com = {{mountain}})
}


dambt <- get_ext(spamb, edat, "Ambang")
dbawt <- get_ext(spbaw, edat, "Bawakaraeng") 
dbult <- get_ext(spbul, edat, "Buliohuto") 
ddakt <- get_ext(spdak, edat, "Dako")
dgant <- get_ext(spgan, edat, "Gandangdewata")
dkatt <- get_ext(spkat, edat, "Katopasa")
dlatt <- get_ext(splat, edat, "Latimojong")
dnokt <- get_ext(spnok, edat, "Nokilalaki")
dtort <- get_ext(sptor, edat, "Torompupu")
ext <- bind_rows(dambt, dbawt, dbult, ddakt, dgant, dkatt, dlatt, dnokt, dtort) 
rm(dambt, dbawt, dbult, ddakt, dgant, dkatt, dlatt, dnokt, dtort)
```

#### Quick Plot
```{r}
ext %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes( x = mTail,y = com)) +
  stat_halfeye(.width = c(0.74, 0.89),  alpha = 0.7) +
  # Add points
  geom_point(aes(x = rTail, y = com), data = extdat) +
  geom_vline(xintercept = 0, linetype = 2) +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) + theme(legend.position = "none")
```

```{r}
ext %>% mutate(com = factor(com, level = level_order)) %>% 
ggplot(aes( x = mTail, y = mHB, color = com)) +
  #geom_density_2d(bins =5, contour_var = "ndensity") +
  # Add points
  geom_jitter(aes(x = rTail, y = HB, size = lMass), data = extdat, width = 0.09, height = 0.09) +
  scale_size(range = c(0.5, 5)) +
  geom_point(size = 8, alpha = 0.01) +
  #labs(title="Cranial Shape Position",x="PC1 Mean", y = "", fill = "Mountain") +
  theme_bw() +
  scale_fill_paletteer_d('ggsci::default_gsea', direction = 1) +
  guides(fill = guide_legend(reverse=T)) #+ 
  #theme(legend.position = "none")
```

###################
#STOPPED HERE
##################




# Morpho NN

This is skull shape and external measurements hb, tail, hf, lmass, ear

```{r}
morph_dat <-  skdat  %>% select(!.row) %>% select(Species, .draw, dPC1, dPC2, dPC3, cPC1, cPC2) %>% 
  full_join(edat, by = c(".draw", "Species"))


df <- morph_dat %>% 
  select(!.row) 

amb_nni <- get_mnni(df, spamb) %>%  mutate(com = "Ambang" )
baw_nni <- get_mnni(df, spbaw) %>%  mutate(com = "Bawakaraeng" )
bul_nni <- get_mnni(df, spbul) %>%  mutate(com = "Buliohuto" )
dak_nni <- get_mnni(df, spdak) %>%  mutate(com = "Dako" )
gan_nni <- get_mnni(df, spgan) %>%  mutate(com = "Gandangdewata" )
kat_nni <- get_mnni(df, spkat) %>%  mutate(com = "Katopasa" )
lat_nni <- get_mnni(df, splat) %>%  mutate(com = "Latimojong" )
nok_nni <- get_mnni(df, spnok) %>%  mutate(com = "Nokilalaki" )
tor_nni <- get_mnni(df, sptor) %>%  mutate(com = "Torompupu" )

nn_morph <- bind_rows(amb_nni, baw_nni, bul_nni, dak_nni, gan_nni, kat_nni, lat_nni, nok_nni, tor_nni) %>% rename(morpho_nn = value)

dd <- nn_morph %>% select(morpho_nn)
adat <- adat %>% bind_cols(dd)


rm(amb_nni, baw_nni, bul_nni, dak_nni, gan_nni, kat_nni, lat_nni, nok_nni, tor_nni)
```

```{r}
adat %>% write_csv(here("All_Traits.csv"))
```

# Isotope GROUP Nearest Neighbor

Realized I have to use the grouping data again. Thats ok. It'll be just like any of the other variables. \## N15 Group

```{r}
idat <- read_csv(here("Isotope_Data", "Isotope_Group_Level_Fitted.csv")) %>% select(Species, .draw, sN15)


amb_nni <- get_mnni(idat, spamb) %>%  mutate(com = "Ambang" )
baw_nni <- get_mnni(idat, spbaw) %>%  mutate(com = "Bawakaraeng" )
bul_nni <- get_mnni(idat, spbul) %>%  mutate(com = "Buliohuto" )
dak_nni <- get_mnni(idat, spdak) %>%  mutate(com = "Dako" )
gan_nni <- get_mnni(idat, spgan) %>%  mutate(com = "Gandangdewata" )
#kat_nni <- get_mnni(idat, spkat) %>%  mutate(com = "Katopasa" )
lat_nni <- get_mnni(idat, splat) %>%  mutate(com = "Latimojong" )
#nok_nni <- get_mnni(idat, spnok) %>%  mutate(com = "Nokilalaki" )
#tor_nni <- get_mnni(idat, sptor) %>%  mutate(com = "Torompupu" )


nn_N <- bind_rows(amb_nni, baw_nni, bul_nni, dak_nni, gan_nni, lat_nni) %>% rename(N15_nn_group = value) %>% mutate(.draw = rep(1:4000, 6))

adat <- adat  %>% 
  full_join(nn_N, by = c(".draw", "com"))
```

## C13 Group

```{r}
idat <- read_csv(here("Isotope_Data", "Isotope_Group_Level_Fitted.csv")) %>% select(Species, .draw, sC13)


amb_nni <- get_mnni(idat, spamb) %>%  mutate(com = "Ambang" )
baw_nni <- get_mnni(idat, spbaw) %>%  mutate(com = "Bawakaraeng" )
bul_nni <- get_mnni(idat, spbul) %>%  mutate(com = "Buliohuto" )
dak_nni <- get_mnni(idat, spdak) %>%  mutate(com = "Dako" )
gan_nni <- get_mnni(idat, spgan) %>%  mutate(com = "Gandangdewata" )
#kat_nni <- get_mnni(idat, spkat) %>%  mutate(com = "Katopasa" )
lat_nni <- get_mnni(idat, splat) %>%  mutate(com = "Latimojong" )
#nok_nni <- get_mnni(idat, spnok) %>%  mutate(com = "Nokilalaki" )
#tor_nni <- get_mnni(idat, sptor) %>%  mutate(com = "Torompupu" )


nn_C <- bind_rows(amb_nni, baw_nni, bul_nni, dak_nni, gan_nni, lat_nni) %>% rename(C13_nn_group = value) %>% mutate(.draw = rep(1:4000, 6))

adat <- adat  %>% 
  full_join(nn_C, by = c(".draw", "com"))
```

## Iso Group

```{r}
idat <- read_csv(here("Isotope_Data", "Isotope_Group_Level_Fitted.csv")) %>% select(Species, .draw, sC13, sN15)


amb_nni <- get_mnni(idat, spamb) %>%  mutate(com = "Ambang" )
baw_nni <- get_mnni(idat, spbaw) %>%  mutate(com = "Bawakaraeng" )
bul_nni <- get_mnni(idat, spbul) %>%  mutate(com = "Buliohuto" )
dak_nni <- get_mnni(idat, spdak) %>%  mutate(com = "Dako" )
gan_nni <- get_mnni(idat, spgan) %>%  mutate(com = "Gandangdewata" )
#kat_nni <- get_mnni(idat, spkat) %>%  mutate(com = "Katopasa" )
lat_nni <- get_mnni(idat, splat) %>%  mutate(com = "Latimojong" )
#nok_nni <- get_mnni(idat, spnok) %>%  mutate(com = "Nokilalaki" )
#tor_nni <- get_mnni(idat, sptor) %>%  mutate(com = "Torompupu" )


nn_i <- bind_rows(amb_nni, baw_nni, bul_nni, dak_nni, gan_nni, lat_nni) %>% rename(iso_nn_group = value) %>% mutate(.draw = rep(1:4000, 6))

adat <- adat  %>% 
  full_join(nn_i, by = c(".draw", "com"))
```

#Write All Data

```{r}
adat %>% write_csv(here("All_Traits.csv"))
```
