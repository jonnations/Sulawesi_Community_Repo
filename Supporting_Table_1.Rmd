---
title: "Supp_Table_1"
author: "Jon Nations"
date: "3/8/2022"
output: html_document
---

# Supporting table 1


Making a big html table of the median and 89% CIs of the v, vses, nn and nnses of all traits. 

# Load Packages and Models
```{r}
pacman::p_load(tidyverse,tidybayes, kableExtra)

dat <- read_csv('All_Traits.csv')
```


I think i need to make a function that generates the median and 89% ci's for all traits in the "all_traits" db. Then I need to arrange the table properly. I am thinking:

```{r}
dt <- data.frame(trait = c(rep("a", 9), rep("b", 9)),
                               com = rep(LETTERS[1:9], times = 2),
                 v = 1:18,
                 vses = 1:18)
kbl(dt, align = "c") %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2, valign = "top")
```
This way I don't really have to worry about the seperate row for the CI, I can jsut put them in parentheses next to the value.

Bottom answer [here](https://stackoverflow.com/questions/34781769/rmarkdown-table-with-cells-that-have-two-values) is the inspiration.

Pulling some scripts from the model script in the Sulawesi Community project


SO... I need to summarise each value for each community, then put them in order, then sort?

I Think it works best to make 4 dataframes, then add the columns together by trait. I will also need to standardize the traits. 
```{r}
dat %>% select(com, contains("v")) %>% 
  select(!contains("ses")) %>% 
  group_by(com) %>% 
  summarise_at(vars(3:69),
               list(u89 = ~quantile(., c(0.945), na.rm = TRUE),
                    l89 = ~quantile(., c(0.055), na.rm = TRUE),
                    mean = ~mean(.,  na.rm = TRUE)),
               .names = "{.fn}")
```


# Functions
Long, but they work!
```{r}
mypaste <- function(x, y, z) {
              paste0(x, " (", y,", ", z, ") ")
}

cleanupRLGA <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:7]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_Intercept[3]" = "Intercept_3",
                        "b_RLGA" = "RLGA",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_RLGA:log_cuberoot_mass" = "RLGA:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}

cleanupRLGA2 <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:6]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_RLGA" = "RLGA",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_RLGA:log_cuberoot_mass" = "RLGA:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}


cleanupOPCr <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:9]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_Intercept[3]" = "Intercept_3",
                        "b_m1_opcr" = "m1_OPCr",
                        "b_m2_opcr" = "m2_OPCr",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_m1_opcr:log_cuberoot_mass" = "m1_OPCr:Mass",
                        "b_log_cuberoot_mass:m2_opcr" = "m2_OPCr:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}

cleanupaDNE <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:9]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_Intercept[3]" = "Intercept_3",
                        "b_m1_dne" = "m1_aDNE",
                        "b_m2_dne" = "m2_aDNE",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_m1_dne:log_cuberoot_mass" = "m1_aDNE:Mass",
                        "b_log_cuberoot_mass:m2_dne" = "m2_aDNE:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}

cleanupRFI <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:9]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_Intercept[3]" = "Intercept_3",
                        "b_RFI_m1" = "m1_RFI",
                        "b_RFI_m2" = "m2_RFI",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_RFI_m1:log_cuberoot_mass" = "m1_RFI:Mass",
                        "b_log_cuberoot_mass:RFI_m2" = "m2_RFI:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}

cleanupALL <- function(brmsfit, food){
  v = get_variables(brmsfit)[1:19]
  df = posterior_summary({{brmsfit}}, probs = c(0.055, 0.945), 
        variable = v) %>% 
  as_tibble(rownames = "par")  %>% 
    select(-Est.Error) %>%
    mutate(par = recode(par, 
                        "b_Intercept[1]" = "Intercept_1",
                        "b_Intercept[2]" = "Intercept_2",
                        "b_Intercept[3]" = "Intercept_3",
                        "b_RFI_m1" = "m1_RFI",
                        "b_RFI_m2" = "m2_RFI",
                        "b_m1_opcr" = "m1_OPCr",
                        "b_m2_opcr" = "m2_OPCr",
                        "b_m1_dne" = "m1_aDNE",
                        "b_m2_dne" = "m2_aDNE",
                        "b_RFI_m1" = "m1_RFI",
                        "b_RFI_m2" = "m2_RFI",
                        "b_RLGA" = "RLGA",
                        "b_log_cuberoot_mass" = "Mass",
                        "b_log_cuberoot_mass:m1_opcr" = "m1_OPCr:Mass",
                        "b_log_cuberoot_mass:m2_opcr" = "m2_OPCr:Mass",
                        "b_log_cuberoot_mass:m1_dne" = "m1_aDNE:Mass",
                        "b_log_cuberoot_mass:m2_dne" = "m2_aDNE:Mass",
                        "b_log_cuberoot_mass:RFI_m1" = "m1_RFI:Mass",
                        "b_log_cuberoot_mass:RFI_m2" = "m2_RFI:Mass",
                        "b_log_cuberoot_mass:RLGA" = "RLGA:Mass",
                        "sd_phylo__Intercept" = "Phylo_sd")) %>% 
    mutate_if(is.numeric, round, 2) 
  nam <- df$par
  x = df$Estimate
  y = df$Q5.5
  z = df$Q94.5
  df2 <- as.data.frame(mypaste(x, y, z))
  bind_cols(nam, df2) %>% 
    rename(parameter = "...1",
           "Estimate (l_89, u_89)" = "mypaste(x, y, z)") %>% 
    gather(est, value, "Estimate (l_89, u_89)") %>% 
    spread(parameter, value) %>% 
    select(!est) %>% 
    add_column(Food = {{food}}) %>% 
    relocate(Food)
}

#beautiful transpose function from https://stackoverflow.com/questions/28917076/transposing-data-frames
df_transpose <- function(df) {
  
  df %>% 
    tidyr::pivot_longer(-1) %>%
    tidyr::pivot_wider(names_from = 1, values_from = value)

}
```

# Make Table
Rlga=bird, fish, large mammal, small mammal
RFI=Egg
OPCr=carrion, fruit
aDNE=herp, plant, seed, soft invert
All=hard invert
**Needs some Reformatting but looks good!!**
```{r}
r1 <- cleanupRLGA(m.bird, "Bird")
r2 <- cleanupRLGA(m.fish, "Fish")
r3 <- cleanupRLGA(m.large, "Large Mammal")
r4 <- cleanupRLGA(m.small, "Small Mammal")

r5 <- cleanupRFI(m.egg, "Egg")

r6 <- cleanupOPCr(m.carrion, "Carrion")
r7 <- cleanupOPCr(m.fruit, "Fruit")

r8 <- cleanupaDNE(m.herp, "Herptile")
r9 <- cleanupaDNE(m.plant, "Plant")
r10 <- cleanupaDNE(m.seed, "Seed")
r11 <- cleanupaDNE(m.soft, "Soft Invert")

r12 <- cleanupRLGA2(m.root, "Root")

r13 <- cleanupALL(m.hard, "Hard Invert")


t <- bind_rows(r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13)   %>% 
  as_tibble() %>% 
  df_transpose() %>% 
  #rename(Parameter = name) %>% 
  select(sort(names(.))) %>% 
  relocate(Parameter = name) %>% 
  kbl() %>% 
   kable_classic_2(full_width = F) %>% 
  #scroll_box(width = "1600px", height = "1000px") %>% 
  save_kable("Supp_model_results_table.png")

t
```


```{r}
kbl(collapse_rows_dt, align = "c") %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:2, valign = "top")
```

